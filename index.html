<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>

    <style type="text/css">

    </style>
</head>
<body>


<script>
    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: {
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };


    let game = new Phaser.Game(config);
    let player;
    let enemy;
    let cursors;
    let virus;
    let shelf;
    let shelfSmall;
    let shelfLarge;
    let score = 0;
    let tp;


    function preload ()
    {
        this.load.image('bg', "assets/img/sky.png");
        this.load.image('ground', "assets/img/shelf.png");
        this.load.image('tp', "assets/img/tp.png");

        this.load.spritesheet('player',
            'assets/img/dude.png',
            { frameWidth: 32, frameHeight: 48 }
        );
        this.load.spritesheet('enemy',
            'assets/img/dude.png',
            { frameWidth: 32, frameHeight: 48 }
        );
    }

    function create ()
    {
        // VIRUS animate
        // virus = this.add.sprite(200, 200, 'virus');

        this.add.image(400, 300, 'bg');
        player = this.physics.add.sprite(30, 570, 'player');
        // player.setBounce(0.5);
        player.setCollideWorldBounds(true);

        // SHELF
        shelf = this.physics.add.staticGroup();
        // shelfSmall = this.physics.add.staticGroup();
        // shelfLarge = this.physics.add.staticGroup();
        // shelf.create(50, 300, 'ground').setScale(.8);
        // shelf.create(320, 150, 'ground').setScale(1.2);
        // shelf.create(600, 500, 'ground');
        // shelf.create(750, 150, 'ground').setScale(1.4).refreshBody()


        createShelves = () => {
            let randomNumX;
            let randomNumY;

            for(let i=0; i < 5; i++) {
                randomNumX = Math.floor((Math.random() * config.width) + 50);
                randomNumY = Math.floor((Math.random() * config.height) + 50);

                shelf.create(randomNumX, randomNumY, 'ground');
                this.add.image(randomNumX, randomNumY - 40, 'tp').setScale(.8);
                this.add.image(randomNumX, randomNumY + 40, 'tp').setScale(.8);

            }
        }
        createShelves();


        // collectTp = (player, tp) =>{
        //     tp.disableBody(true, true)
        // }
        // this.physics.add.overlap(player, tp, collectTp, null, this);
        // collectTp(player, tp);

        // player collide w shelf
        this.physics.add.collider(player, shelf);
        this.physics.add.collider(player, tp);

        // ENEMY
        enemy = this.physics.add.sprite(350, 350, 'enemy');
        enemy.setCollideWorldBounds(true);
        enemy.setTint(0xff0000);

        // enemy collide w shelf
        this.physics.add.collider(enemy, shelf);

        function generateEnemies(enemy){
            // generate more enemies with time
        }

        virus = this.physics.add.group();
        function hitVirus (player, virus) {
            this.physics.pause();

            player.setTint(0xff0000);

            player.anims.play('turn');

            gameOver = true;
        }
        this.physics.add.collider(player, virus, hitVirus, null, this);
        this.physics.moveToObject(enemy, player, 60, 9000);
        this.physics.add.collider(player, enemy, hitVirus, null, this);

        scoreText = this.add.text(16, 16, 'points: 0', { fontSize: '24px', fill: '#662994' });


        // player movement
        this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }),
            frameRate: 10,
            repeat: -1
        });

        this.anims.create({
            key: 'turn',
            frames: [ { key: 'player', frame: 4 } ],
            frameRate: 20
        });

        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('player', { start: 5, end: 8 }),
            frameRate: 10,
            repeat: -1
        });
    }

    function update () {
        virus.x -= 2;

        cursors = this.input.keyboard.createCursorKeys();
        this.physics.moveToObject(enemy, player, 60, 9000);

        player.setVelocity(0, 0);

        if (cursors.left.isDown)
        {
            player.setVelocityX(-200);

            player.anims.play('left', true);
        }
        else if (cursors.right.isDown)
        {
            player.setVelocityX(200);

            player.anims.play('right', true);
        }
        else if (cursors.up.isDown)
        {
            player.setVelocityY(-200);
        }
        else if (cursors.down.isDown)
        {
            player.setVelocityY(200);
        }
        else
        {
            player.anims.play('left', false);
            player.anims.play('right', false);
            player.anims.play('turn');
        }
    }


    /*TODO
    *
    * */
</script>

</body>
</html>
